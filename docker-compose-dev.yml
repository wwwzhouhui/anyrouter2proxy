version: '3.8'

# AnyRouter2Proxy - Node.js SDK 模式（开发环境）
# 架构: 客户端 → Python (9998/9999) → Node.js (4000) → anyrouter.top

services:
  # Node.js 代理（核心，处理 WAF 和 TLS 指纹）
  node-proxy:
    build:
      context: ./node-proxy
      dockerfile: Dockerfile
    image: anyrouter-node-proxy:dev
    container_name: anyrouter-node-proxy
    restart: unless-stopped
    environment:
      - NODE_PROXY_PORT=${NODE_PROXY_PORT:-4000}
      - ANYROUTER_BASE_URL=${ANYROUTER_BASE_URL:-https://anyrouter.top}
    ports:
      - "4000:4000"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - anyrouter-proxy

  # Anthropic 协议代理服务
  anthropic-proxy:
    build:
      context: .
      dockerfile: Dockerfile
    image: anyrouter2proxy:anthropic-dev
    container_name: anyrouter-anthropic-proxy
    restart: unless-stopped
    depends_on:
      node-proxy:
        condition: service_healthy
    environment:
      - RUN_MODE=anthropic
      - NODE_PROXY_URL=http://node-proxy:4000
      - PORT=${PORT:-9998}
      - HOST=${HOST:-0.0.0.0}
      - HTTP_TIMEOUT=${HTTP_TIMEOUT:-120}
      - DEFAULT_MAX_TOKENS=${DEFAULT_MAX_TOKENS:-8192}
    ports:
      - "9998:9998"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9998/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s
    networks:
      - anyrouter-proxy

  # OpenAI 协议代理服务
  openai-proxy:
    build:
      context: .
      dockerfile: Dockerfile
    image: anyrouter2proxy:openai-dev
    container_name: anyrouter-openai-proxy
    restart: unless-stopped
    depends_on:
      node-proxy:
        condition: service_healthy
    environment:
      - RUN_MODE=openai
      - NODE_PROXY_URL=http://node-proxy:4000
      - OPENAI_PROXY_PORT=${OPENAI_PROXY_PORT:-9999}
      - HOST=${HOST:-0.0.0.0}
      - HTTP_TIMEOUT=${HTTP_TIMEOUT:-120}
      - DEFAULT_MAX_TOKENS=${DEFAULT_MAX_TOKENS:-8192}
      - FORCE_NON_STREAM=${FORCE_NON_STREAM:-false}
      - DEFAULT_SYSTEM_PROMPT=${DEFAULT_SYSTEM_PROMPT:-You are Claude, a helpful AI assistant.}
    ports:
      - "9999:9999"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9999/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s
    networks:
      - anyrouter-proxy

networks:
  anyrouter-proxy:
    driver: bridge
